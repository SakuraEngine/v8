name: test artifact

on: 
  workflow_dispatch:
    inputs:
      tag:
        description: 'release tag'
        required: true
        default: 'test_artifact'

jobs:
  upload-windows:
    strategy:
      fail-fast: false
      matrix:
        arch: [ x64 ]
        toolchain: [ msvc, clang-cl ]

    name: ${{ matrix.toolchain }} + ${{ matrix.arch }}
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Copy artifact
        shell: cmd
        run: |
          cd %GITHUB_WORKSPACE%
          set ARTIFACT_PATH=artifact/test-windows-${{ matrix.arch }}-${{ matrix.toolchain }}
          mkdir "%ARTIFACT_PATH%"
          copy /Y windows_x64.cmd "%ARTIFACT_PATH%"
          copy /Y LICENSE "%ARTIFACT_PATH%"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-windows-${{ matrix.arch }}-${{ matrix.toolchain }}
          path: artifact/

  release:
    runs-on: ubuntu-latest
    needs: [upload-windows]
    steps:
      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          path: build_release/artifact
          merge-multiple: true
      
      - name: Display downloaded artifact
        run: |
          cd build_release
          ls -R
          cd ..
      
      - name: Create Release Asset
        run: |
          cd build_release
          mkdir package
          cd artifact
          for dir in `ls -d */`; do
            dir=${dir%*/}
            tar -vz -cf ../package/$dir.tgz $dir
            xmake l hash.sha256 ../package/$dir.tgz
          done
          cd ../../
      
      - name: Upload release files
        uses: meeDamian/github-release@2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: ${{ inputs.tag }}
          tag: ${{ inputs.tag }}
          draft: false
          prerelease: false
          files: build_release/ziped/
